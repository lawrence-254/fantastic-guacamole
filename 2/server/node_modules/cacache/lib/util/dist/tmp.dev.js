'use strict';

var fs = require('@npmcli/fs');

var fixOwner = require('./fix-owner');

var path = require('path');

module.exports.mkdir = mktmpdir;

function mktmpdir(cache) {
  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var tmpPrefix = opts.tmpPrefix;
  var tmpDir = path.join(cache, 'tmp');
  return fs.mkdir(tmpDir, {
    recursive: true,
    owner: 'inherit'
  }).then(function () {
    // do not use path.join(), it drops the trailing / if tmpPrefix is unset
    var target = "".concat(tmpDir).concat(path.sep).concat(tmpPrefix || '');
    return fs.mkdtemp(target, {
      owner: 'inherit'
    });
  });
}

module.exports.withTmp = withTmp;

function withTmp(cache, opts, cb) {
  if (!cb) {
    cb = opts;
    opts = {};
  }

  return fs.withTempDir(path.join(cache, 'tmp'), cb, opts);
}

module.exports.fix = fixtmpdir;

function fixtmpdir(cache) {
  return fixOwner(cache, path.join(cache, 'tmp'));
}